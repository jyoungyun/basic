name: release

on:
  pull_request:
    branches: [ master ]

env:
  RELEASE_SEMVER: 1.1.0
  BUILD_TYPE: nightly

jobs:
  set_strategy:
    runs-on: [ ubuntu-latest ]
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
    steps:
      - name: Get current date
        id: date
        run: |
          echo "::set-output name=date::$(date +'%y%m%d%H')"
      - name: Generate release configuration matrix
        id: set-matrix
        run: |
          ubuntu_1804="{ \
            \"os\":\"ubuntu-18.04\", \
            \"test_os\":\"ubuntu-18.04\", \
            \"source_repo\":\"bionic-nightly\", \
            \"target_repo\":\"bionic-dev\", \
            \"test_repo\":\"bionic-nightly-test-${{ steps.date.outputs.date }}\" }"
          ubuntu_2004="{ \
            \"os\":\"ubuntu-20.04\", \
            \"test_os\":\"ubuntu-20.04\", \
            \"source_repo\":\"focal-nightly\", \
            \"target_repo\":\"focal-dev\", \
            \"test_repo\":\"focal-nightly-test-${{ steps.date.outputs.date }}\" }"
          echo "::set-output name=matrix::{\"include\":[$ubuntu_1804, $ubuntu_2004]}"

  build_metapkgs:
    needs: set_strategy
    strategy:
      fail-fast: false
      matrix: ${{ fromJson(needs.set_strategy.outputs.matrix) }}
    runs-on: [ ${{ matrix.os }} ]
    steps:
      - name: Print configuration
        run: |
          touch ${{ matrix.source_repo }}.conf
          echo "os: ${{ matrix.os }}" | tee -a ${{ matrix.source_repo }}.conf
          echo "test_os: ${{ matrix.test_os }}" | tee -a ${{ matrix.source_repo }}.conf
          echo "source_repo: ${{ matrix.source_repo }}" | tee -a ${{ matrix.source_repo }}.conf
          echo "target_repo: ${{ matrix.target_repo }}" | tee -a ${{ matrix.source_repo }}.conf
          echo "test_repo: ${{ matrix.test_repo }}" | tee -a ${{ matrix.source_repo }}.conf
          cat ${{ matrix.source_repo }}.conf
      - name: Upload artifacts
        uses: actions/upload-artifact@v2
        with:
          name: ${{ matrix.source_repo }}-file
          path: ${{ matrix.source_repo }}.conf
          redention-days: 5

  simulate_test_packages:
    needs:
      - set_strategy
      - build_metapkgs
    strategy:
      fail-fast: false
      matrix: ${{ fromJson(needs.set_strategy.outputs.matrix) }}
    runs-on: [ ${{ matrix.os }} ]
    steps:
      - name: Download artifacts
        uses: actions/download-artifact@v2
        with:
          name: ${{ matrix.source_repo }}-file
      - name: Print configuration
        run: |
          cat ${{ matrix.source_repo }}.conf

  run_integration_test:
    needs:
      - set_strategy
      - simulate_test_packages
    strategy:
      fail-fast: false
      matrix: ${{ fromJson(needs.set_strategy.outputs.matrix) }}
        test: [all-model-test, one-cmds-test]
    runs-on: [ ${{ matrix.test_os }} ]
    steps:
      - name: Check out repository code
        uses: actions/checkout@v2
      - name: Run all model test
        id: all-model-test
        if: ${{ matrix.test == 'all-model-test' }}
        uses: ./.github/actions/all-model-test
        with:
          source_repo: ${{ matrix.test_repo }}
          build_type: ${{ env.BUILD_TYPE }}
          enable_data_download: 1
          trivsetup_generate_tv2s: 1
          path: /tmp/RESULT
      - name: Run ils compile test
        id: ils-compile-test
        if: ${{ matrix.test == 'all-model-test' && steps.all-model-test.conclusion == 'success'}}
        uses: ./.github/actions/ils-compile-test
        with:
          source_repo: ${{ matrix.test_repo }}
          build_type: ${{ env.BUILD_TYPE }}
          path: /tmp/RESULT
      - name: Run ils policy test
        id: ils-ils-policy-test
        if: ${{ matrix.test == 'all-model-test' && steps.ils-compile-test.conclusion == 'success'}}
        uses: ./.github/actions/ils-policy-test
        with:
          source_repo: ${{ matrix.test_repo }}
          build_type: ${{ env.BUILD_TYPE }}
          path: /tmp/RESULT
      - name: Run one cmds test
        id: one-cmds-test
        if: ${{ matrix.test == 'one-cmds-test' }}
        uses: ./.github/actions/one-cmds-test
        with:
          source_repo: ${{ matrix.test_repo }}
          build_type: ${{ env.BUILD_TYPE }}
          path: /tmp/RESULT

  delete_test_repository:
    needs:
      - set_strategy
      - run_integration_test
    strategy:
      fail-fast: false
      matrix: ${{ fromJson(needs.set_strategy.outputs.matrix) }}
    runs-on: [ ${{ matrix.os }} ]
    steps:
      - name: Print configuration
        run: |
          echo "delete_test_repository"
